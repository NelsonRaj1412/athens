"""
Django management command to calibrate and test face recognition accuracy
Usage: python manage.py calibrate_face_recognition --user_id 1 --test_images /path/to/test/images/
"""

from django.core.management.base import BaseCommand
from django.contrib.auth import get_user_model
from authentication.models import UserDetail, AdminDetail
from authentication.face_recognition_utils import (
    calibrate_face_recognition_thresholds,
    test_face_recognition_consistency,
    enhanced_face_comparison,
    get_face_quality_metrics
)\nimport os\nimport json

User = get_user_model()

class Command(BaseCommand):\n    help = 'Calibrate face recognition thresholds and test accuracy for specific users'\n\n    def add_arguments(self, parser):\n        parser.add_argument('--user_id', type=int, help='User ID to calibrate')\n        parser.add_argument('--username', type=str, help='Username to calibrate')\n        parser.add_argument('--test_images', type=str, help='Directory containing test images of the user')\n        parser.add_argument('--consistency_tests', type=int, default=10, help='Number of consistency tests to run')\n        parser.add_argument('--output_file', type=str, help='File to save calibration results')\n        parser.add_argument('--all_users', action='store_true', help='Test all users with photos')\n\n    def handle(self, *args, **options):\n        if options['all_users']:\n            self.calibrate_all_users(options)\n        elif options['user_id'] or options['username']:\n            self.calibrate_single_user(options)\n        else:\n            self.stdout.write(self.style.ERROR('Please specify --user_id, --username, or --all_users'))\n\n    def calibrate_single_user(self, options):\n        try:\n            # Get user\n            if options['user_id']:\n                user = User.objects.get(id=options['user_id'])\n            else:\n                user = User.objects.get(username=options['username'])\n            \n            self.stdout.write(f\"Calibrating face recognition for user: {user.username} (ID: {user.id})\")\n            \n            # Get user's photo\n            photo_path = self.get_user_photo_path(user)\n            if not photo_path:\n                self.stdout.write(self.style.ERROR(f\"No photo found for user {user.username}\"))\n                return\n            \n            self.stdout.write(f\"Using reference photo: {photo_path}\")\n            \n            # Test image quality\n            self.stdout.write(\"\\n=== Image Quality Analysis ===\")\n            quality_result = get_face_quality_metrics(photo_path)\n            if quality_result.get('status') == 'success':\n                metrics = quality_result['metrics']\n                self.stdout.write(f\"Overall Quality: {metrics.get('overall_rating', 'Unknown')} ({metrics.get('overall_quality_score', 0):.2f})\")\n                self.stdout.write(f\"Sharpness: {metrics.get('sharpness_rating', 'Unknown')} ({metrics.get('sharpness', 0):.1f})\")\n                self.stdout.write(f\"Brightness: {metrics.get('brightness_rating', 'Unknown')} ({metrics.get('brightness', 0):.1f})\")\n                self.stdout.write(f\"Contrast: {metrics.get('contrast_rating', 'Unknown')} ({metrics.get('contrast', 0):.1f})\")\n                if 'faces_detected' in metrics:\n                    self.stdout.write(f\"Faces Detected: {metrics['faces_detected']}\")\n            else:\n                self.stdout.write(self.style.WARNING(f\"Quality analysis failed: {quality_result.get('error')}\"))\n            \n            # Run consistency tests\n            self.stdout.write(\"\\n=== Consistency Testing ===\")\n            consistency_result = test_face_recognition_consistency(\n                photo_path, \n                num_tests=options['consistency_tests']\n            )\n            \n            if consistency_result.get('status') == 'success':\n                self.stdout.write(f\"Match Rate: {consistency_result['match_rate']:.1%}\")\n                self.stdout.write(f\"Average Confidence: {consistency_result['avg_confidence']:.3f}\")\n                self.stdout.write(f\"Confidence Std Dev: {consistency_result['confidence_std']:.3f}\")\n                self.stdout.write(f\"Consistency Rating: {consistency_result['consistency_rating']}\")\n            else:\n                self.stdout.write(self.style.WARNING(f\"Consistency test failed: {consistency_result.get('error')}\"))\n            \n            # Calibrate thresholds if test images provided\n            if options['test_images']:\n                self.stdout.write(\"\\n=== Threshold Calibration ===\")\n                calibration_result = calibrate_face_recognition_thresholds(\n                    photo_path, \n                    options['test_images']\n                )\n                \n                if calibration_result.get('status') == 'success':\n                    analysis = calibration_result['analysis']\n                    recommendations = calibration_result['recommendations']\n                    \n                    self.stdout.write(f\"Images Processed: {analysis['images_processed']}\")\n                    self.stdout.write(f\"Average Confidence: {analysis['avg_confidence']:.3f}\")\n                    self.stdout.write(f\"Confidence Std Dev: {analysis['std_confidence']:.3f}\")\n                    self.stdout.write(f\"Consistency Score: {recommendations['consistency_score']:.3f}\")\n                    self.stdout.write(\"\\nRecommended Thresholds:\")\n                    self.stdout.write(f\"  Confidence Threshold: {recommendations['confidence_threshold']:.3f}\")\n                    self.stdout.write(f\"  Distance Threshold: {recommendations['distance_threshold']:.3f}\")\n                else:\n                    self.stdout.write(self.style.WARNING(f\"Calibration failed: {calibration_result.get('error')}\"))\n            \n            # Save results if output file specified\n            if options['output_file']:\n                results = {\n                    'user_id': user.id,\n                    'username': user.username,\n                    'photo_path': photo_path,\n                    'quality_analysis': quality_result,\n                    'consistency_test': consistency_result\n                }\n                \n                if options['test_images']:\n                    results['calibration'] = calibration_result\n                \n                with open(options['output_file'], 'w') as f:\n                    json.dump(results, f, indent=2, default=str)\n                \n                self.stdout.write(f\"\\nResults saved to: {options['output_file']}\")\n            \n        except User.DoesNotExist:\n            self.stdout.write(self.style.ERROR('User not found'))\n        except Exception as e:\n            self.stdout.write(self.style.ERROR(f'Error: {str(e)}'))\n\n    def calibrate_all_users(self, options):\n        self.stdout.write(\"Calibrating face recognition for all users with photos...\")\n        \n        # Get all users with photos\n        users_with_photos = []\n        \n        # Check UserDetail photos\n        for user_detail in UserDetail.objects.filter(photo__isnull=False).exclude(photo=''):\n            if user_detail.photo and os.path.exists(user_detail.photo.path):\n                users_with_photos.append((user_detail.user, user_detail.photo.path))\n        \n        # Check AdminDetail photos\n        for admin_detail in AdminDetail.objects.filter(photo__isnull=False).exclude(photo=''):\n            if admin_detail.photo and os.path.exists(admin_detail.photo.path):\n                users_with_photos.append((admin_detail.user, admin_detail.photo.path))\n        \n        self.stdout.write(f\"Found {len(users_with_photos)} users with photos\")\n        \n        all_results = []\n        \n        for user, photo_path in users_with_photos:\n            self.stdout.write(f\"\\n{'='*50}\")\n            self.stdout.write(f\"Testing user: {user.username} (ID: {user.id})\")\n            \n            # Quick quality and consistency test\n            quality_result = get_face_quality_metrics(photo_path)\n            consistency_result = test_face_recognition_consistency(photo_path, num_tests=5)\n            \n            result = {\n                'user_id': user.id,\n                'username': user.username,\n                'photo_path': photo_path,\n                'quality_score': quality_result.get('metrics', {}).get('overall_quality_score', 0),\n                'quality_rating': quality_result.get('metrics', {}).get('overall_rating', 'Unknown'),\n                'consistency_score': consistency_result.get('confidence_std', 1.0),\n                'match_rate': consistency_result.get('match_rate', 0.0),\n                'avg_confidence': consistency_result.get('avg_confidence', 0.0)\n            }\n            \n            all_results.append(result)\n            \n            self.stdout.write(f\"  Quality: {result['quality_rating']} ({result['quality_score']:.2f})\")\n            self.stdout.write(f\"  Match Rate: {result['match_rate']:.1%}\")\n            self.stdout.write(f\"  Avg Confidence: {result['avg_confidence']:.3f}\")\n        \n        # Summary statistics\n        self.stdout.write(f\"\\n{'='*50}\")\n        self.stdout.write(\"SUMMARY STATISTICS\")\n        \n        if all_results:\n            quality_scores = [r['quality_score'] for r in all_results]\n            match_rates = [r['match_rate'] for r in all_results]\n            confidences = [r['avg_confidence'] for r in all_results]\n            \n            self.stdout.write(f\"Average Quality Score: {sum(quality_scores)/len(quality_scores):.3f}\")\n            self.stdout.write(f\"Average Match Rate: {sum(match_rates)/len(match_rates):.1%}\")\n            self.stdout.write(f\"Average Confidence: {sum(confidences)/len(confidences):.3f}\")\n            \n            # Identify problematic users\n            low_quality = [r for r in all_results if r['quality_score'] < 0.6]\n            low_match_rate = [r for r in all_results if r['match_rate'] < 0.8]\n            \n            if low_quality:\n                self.stdout.write(f\"\\nUsers with low quality photos ({len(low_quality)}):\")\n                for r in low_quality:\n                    self.stdout.write(f\"  - {r['username']} (Quality: {r['quality_score']:.2f})\")\n            \n            if low_match_rate:\n                self.stdout.write(f\"\\nUsers with low match rates ({len(low_match_rate)}):\")\n                for r in low_match_rate:\n                    self.stdout.write(f\"  - {r['username']} (Match Rate: {r['match_rate']:.1%})\")\n        \n        # Save results if output file specified\n        if options['output_file']:\n            with open(options['output_file'], 'w') as f:\n                json.dump(all_results, f, indent=2, default=str)\n            self.stdout.write(f\"\\nResults saved to: {options['output_file']}\")\n\n    def get_user_photo_path(self, user):\n        \"\"\"Get the photo path for a user from UserDetail or AdminDetail\"\"\"\n        try:\n            # Try UserDetail first\n            user_detail = UserDetail.objects.get(user=user)\n            if user_detail.photo and os.path.exists(user_detail.photo.path):\n                return user_detail.photo.path\n        except UserDetail.DoesNotExist:\n            pass\n        \n        try:\n            # Try AdminDetail\n            admin_detail = AdminDetail.objects.get(user=user)\n            if admin_detail.photo and os.path.exists(admin_detail.photo.path):\n                return admin_detail.photo.path\n        except AdminDetail.DoesNotExist:\n            pass\n        \n        return None